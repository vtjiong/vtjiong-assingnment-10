<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <title>KMeans Clustering Algorithm</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
        }
        label, select {
            font-size: 16px;
            padding: 10px;
            margin: 10px;
        }
        button {
            font-size: 16px;
            padding: 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            margin: 10px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .container {
            width: 60%;
            margin: 0 auto;
        }
        .manual-mode {
            display: none;
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>KMeans Clustering Algorithm</h1>

        <form id="kmeansForm">
            <label for="k">Number of Clusters (k):</label>
            <input type="number" id="k" name="k" min="1" max="100" required>

            <label for="dropdown">Initialization Method:</label>
            <select id="dropdown" name="options">
                <option value="random">Random</option>
                <option value="farthest">Farthest First</option>
                <option value="kmeans">KMeans++</option>
                <option value="manual">Manual</option>
            </select>

            <br>
            <button type="button" id="stepBtn" value="step">Step through KMeans</button>
            <button type="button" id="convergeBtn" value="converge">Converge</button>
            <button type="button" id="generateBtn" value="generate">Generate New Dataset</button>
            <button type="button" id="resetBtn" value="reset">Reset Algorithm</button>
        </form>

        <!-- Placeholder for dynamically updating the image of the graph -->
        <img id="graph" src="data:image/png;base64,{{ plot_url }}" alt="KMeans Clustering Result">

        <!-- Section for Manual Centroid Selection -->
        <div id="manualMode" class="manual-mode">
            <p>Manual Mode: Click on the graph to select centroids</p>
            <ul id="centroidList"></ul>
        </div>
    </div>

    <script>
        // Global variable to store manually selected centroids
        let manualCentroids = [];

        // Function to submit the form data via AJAX
        function submitKMeansForm(actionValue) {
            var xhr = new XMLHttpRequest();
            var form = document.getElementById('kmeansForm');
            var formData = new FormData(form);
            formData.append('action', actionValue);

            // Append manually selected centroids if manual initialization is selected
            if (document.getElementById('dropdown').value === 'manual') {
                formData.append('manualCentroids', JSON.stringify(manualCentroids));
            }

            xhr.open('POST', '/', true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    document.getElementById('graph').src = 'data:image/png;base64,' + xhr.responseText;
                }
            };
            xhr.send(formData);
        }

        // Event listeners for each button
        document.getElementById('stepBtn').addEventListener('click', function() {
            submitKMeansForm('step');
        });

        document.getElementById('convergeBtn').addEventListener('click', function() {
            submitKMeansForm('converge');
        });

        document.getElementById('generateBtn').addEventListener('click', function() {
            submitKMeansForm('generate');
        });

        document.getElementById('resetBtn').addEventListener('click', function() {
            submitKMeansForm('reset');
        });

        // Detect changes in the initialization method dropdown
        document.getElementById('dropdown').addEventListener('change', function() {
            var manualModeDiv = document.getElementById('manualMode');
            if (this.value === 'manual') {
                manualModeDiv.style.display = 'block';
                enableGraphClick();
            } else {
                manualModeDiv.style.display = 'none';
                disableGraphClick();
            }
        });

        // Enable click on the graph for manual centroid selection
        function enableGraphClick() {
            document.getElementById('graph').addEventListener('click', selectCentroid);
        }

        // Disable click on the graph when not in manual mode
        function disableGraphClick() {
            document.getElementById('graph').removeEventListener('click', selectCentroid);
            manualCentroids = [];  // Clear previously selected centroids
            document.getElementById('centroidList').innerHTML = '';  // Clear the displayed list
        }

        // Function to handle centroid selection by clicking on the graph
        function selectCentroid(event) {
            // Get the bounding box of the image
            var rect = event.target.getBoundingClientRect();

            // Calculate the click coordinates relative to the image (pixel-based)
            var xPixel = event.clientX - rect.left;
            var yPixel = event.clientY - rect.top;

            // The graph's coordinate system ranges from -10 to 10 (both axes)
            var xNormalized = ((xPixel / rect.width) * 20) - 10;  // Scale to range [-10, 10]
            var yNormalized = ((yPixel / rect.height) * -20) + 10;  // Scale to range [-10, 10] and invert y

            // Store the selected centroid
            manualCentroids.push({x: xNormalized, y: yNormalized});

            // Display the selected centroid
            var centroidList = document.getElementById('centroidList');
            var li = document.createElement('li');
            li.innerText = `Centroid ${manualCentroids.length}: (${xNormalized.toFixed(2)}, ${yNormalized.toFixed(2)})`;
            centroidList.appendChild(li);

            // Create a label on the graph (this would ideally be handled by the backend with a new plot image)
            var label = document.createElement('div');
            label.style.position = 'absolute';
            label.style.left = `${event.clientX}px`;
            label.style.top = `${event.clientY}px`;
            label.style.color = 'red';
            label.innerText = `C${manualCentroids.length}`;
            document.body.appendChild(label);
        }
    </script>
</body>
</html>